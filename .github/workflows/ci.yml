name: CI - Backend Tests and Docker Build

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]

jobs:
    # ==================================================
    # Python Backend Tests
    # ==================================================
    test-python-backend:
        name: Python Backend - Unit & Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: domunity_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
                  cache-dependency-path: backend-python/requirements.txt

            - name: Install dependencies
              working-directory: backend-python
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Generate proto files
              working-directory: backend-python
              run: |
                  chmod +x generate_proto.sh
                  ./generate_proto.sh

            - name: Run unit tests
              working-directory: backend-python
              run: |
                  pytest test_unit.py -v --cov=. --cov-report=xml --cov-report=term
              env:
                  JWT_SECRET: test-secret-key

            - name: Run integration tests
              working-directory: backend-python
              run: |
                  pytest test_integration.py -v --cov=. --cov-report=xml --cov-report=term --cov-append
              env:
                  TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/domunity_test
                  JWT_SECRET: test-secret-key

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: ./backend-python/coverage.xml
                  flags: python
                  name: python-backend
              continue-on-error: true

    # ==================================================
    # Node.js Backend Tests
    # ==================================================
    test-nodejs-backend:
        name: Node.js Backend - Unit & Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: domunity_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              working-directory: backend-nodejs
              run: npm install

            - name: Generate proto files
              working-directory: backend-nodejs
              run: npm run generate-proto

            - name: Run tests with coverage
              working-directory: backend-nodejs
              run: npm test
              env:
                  TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/domunity_test
                  JWT_SECRET: test-secret-key

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: ./backend-nodejs/coverage/coverage-final.json
                  flags: nodejs
                  name: nodejs-backend
              continue-on-error: true

    # ==================================================
    # Go Backend Tests
    # ==================================================
    test-go-backend:
        name: Go Backend - Unit & Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: domunity_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.23"

            - name: Update go.sum and install dependencies
              working-directory: backend-go
              run: |
                  go mod tidy
                  go mod download

            - name: Generate proto files
              working-directory: backend-go
              run: |
                  go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.34.2
                  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.5.1
                  sudo apt-get update && sudo apt-get install -y protobuf-compiler
                  mkdir -p proto
                  protoc --go_out=./proto --go_opt=paths=source_relative \
                         --go-grpc_out=./proto --go-grpc_opt=paths=source_relative \
                         -I ../proto ../proto/domunity.proto

            - name: Run tests with coverage
              working-directory: backend-go
              run: go test -v -coverprofile=coverage.out -covermode=atomic ./...
              env:
                  TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/domunity_test
                  JWT_SECRET: test-secret-key

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: ./backend-go/coverage.out
                  flags: go
                  name: go-backend
              continue-on-error: true

    # ==================================================
    # Docker Build Tests
    # ==================================================
    test-docker-builds:
        name: Docker - Build and Verify Images
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                backend: [python, nodejs, go]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image - ${{ matrix.backend }}
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./backend-${{ matrix.backend }}/Dockerfile
                  push: false
                  load: true
                  tags: domunity-backend-${{ matrix.backend }}:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      BUILDKIT_CONTEXT_KEEP_GIT_DIR=1

            - name: Test Docker image startup
              run: |
                  docker run --name test-${{ matrix.backend }} -d \
                    -e DATABASE_URL=postgresql://user:pass@localhost:5432/db \
                    -e JWT_SECRET=test-secret \
                    -e PORT=50051 \
                    -e HTTP_PORT=8080 \
                    domunity-backend-${{ matrix.backend }}:test || true

                  # Give container time to start (or fail)
                  sleep 5

                  # Check if container is running or exited gracefully
                  docker ps -a --filter "name=test-${{ matrix.backend }}" --format "{{.Status}}"

                  # Get logs
                  docker logs test-${{ matrix.backend }} || true

                  # Cleanup
                  docker rm -f test-${{ matrix.backend }} || true

            - name: Inspect image
              run: |
                  docker image inspect domunity-backend-${{ matrix.backend }}:test
                  docker history domunity-backend-${{ matrix.backend }}:test

    # ==================================================
    # Frontend Build Test
    # ==================================================
    test-frontend-build:
        name: Frontend - Build Verification
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              working-directory: frontend
              run: npm install

            - name: Build frontend
              working-directory: frontend
              run: npm run build
              env:
                  REACT_APP_BACKEND_URL: http://localhost:8080

            - name: Check build output
              working-directory: frontend
              run: |
                  if [ ! -d "build" ]; then
                    echo "Build directory not found!"
                    exit 1
                  fi
                  if [ ! -f "build/index.html" ]; then
                    echo "index.html not found in build!"
                    exit 1
                  fi
                  echo "Build successful! Output:"
                  ls -lah build/

    # ==================================================
    # Render.yaml Validation
    # ==================================================
    validate-render-config:
        name: Validate Render.yaml Configuration
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate render.yaml syntax
              run: |
                  # Install yq for YAML validation
                  sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
                  sudo chmod +x /usr/local/bin/yq

                  # Validate YAML syntax
                  yq eval '.' render.yaml > /dev/null
                  echo "âœ“ render.yaml syntax is valid"

            - name: Check required fields
              run: |
                  # Check for required service fields
                  services=$(yq eval '.services | length' render.yaml)
                  echo "Found $services services in render.yaml"

                  if [ "$services" -eq 0 ]; then
                    echo "âœ— No services defined in render.yaml"
                    exit 1
                  fi

                  # Verify each service has required fields
                  yq eval '.services[] | select(.type == "web") | .name' render.yaml
                  yq eval '.services[] | select(.type == "web") | .dockerfilePath' render.yaml

                  echo "âœ“ render.yaml contains valid service definitions"

            - name: Verify Dockerfile paths
              run: |
                  # Check that referenced Dockerfiles exist
                  for dockerfile in $(yq eval '.services[] | select(.dockerfilePath) | .dockerfilePath' render.yaml); do
                    if [ -f "$dockerfile" ]; then
                      echo "âœ“ Found: $dockerfile"
                    else
                      echo "âœ— Missing: $dockerfile"
                      exit 1
                    fi
                  done

            - name: Check environment variables
              run: |
                  # Verify critical environment variables are defined
                  echo "Checking for required environment variables..."
                  yq eval '.services[] | select(.envVars) | .envVars[] | .key' render.yaml | sort | uniq

                  # Check that JWT_SECRET is set to generate or from secret
                  jwt_secrets=$(yq eval '.services[] | select(.envVars) | .envVars[] | select(.key == "JWT_SECRET")' render.yaml)
                  if [ -z "$jwt_secrets" ]; then
                    echo "âš  Warning: JWT_SECRET not found in any service"
                  else
                    echo "âœ“ JWT_SECRET configuration found"
                  fi

    # ==================================================
    # Security Scanning
    # ==================================================
    security-scan:
        name: Security - Dependency Scanning
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"
              continue-on-error: true

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: "trivy-results.sarif"
              continue-on-error: true

    # ==================================================
    # Summary Job
    # ==================================================
    ci-success:
        name: All CI Checks Passed
        runs-on: ubuntu-latest
        needs:
            - test-python-backend
            - test-nodejs-backend
            - test-go-backend
            - test-docker-builds
            - test-frontend-build
            - validate-render-config

        steps:
            - name: Summary
              run: |
                  echo "ðŸŽ‰ All CI checks passed successfully!"
                  echo ""
                  echo "âœ“ Python backend tests passed"
                  echo "âœ“ Node.js backend tests passed"
                  echo "âœ“ Go backend tests passed"
                  echo "âœ“ Docker builds successful"
                  echo "âœ“ Frontend build successful"
                  echo "âœ“ Render.yaml validated"
                  echo ""
                  echo "Ready to merge! ðŸš€"
